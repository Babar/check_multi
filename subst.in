#!@PERL@ -w

my ${prefix}="@prefix@";
my ${exec_prefix}="@exec_prefix@";
my ${LIBEXECDIR}="@prefix@/libexec";
my ${multi_config_dir}="@multi_config_dir@";
my ${multi_nagios_images}="@multi_nagios_images@";
my ${multi_pnp_path}="@multi_pnp_path@";
my ${multi_service_definition_template}="@multi_service_definition_template@";
my ${multi_tmp_etc}="@multi_tmp_etc@";

while (my $f = shift @ARGV) {

	if (-x "/bin/mktemp") { 
		$TEMP = `/bin/mktemp $f.$$.XXXXXX`;
		die "Cannot make temporary file $TEMP" if($?);
		chomp $TEMP;
	} else {
		$XXXXXX = rand;
		$TEMP = "$f.$$.$XXXXXX";
	}

	open(IN,"<$f.in") || die "Cannot open input file $f.in:$!";
	open(OUT,">${TEMP}") || die "Cannot write to temporary file ${TEMP}:$!";

	while (<IN>) {
		s|\@PERL\@|@PERL@|g;
		s|\@nagios_user\@|@nagios_user@|g;
		s|\@nagios_group\@|@nagios_group@|g;
		s|\@localstatedir\@|@localstatedir@|g;
		s|\@multi_action_url\@|@multi_action_url@|g;
		s|\@multi_child_timeout\@|@multi_child_timeout@|g;
		s|\@multi_collapse\@|@multi_collapse@|g;
		s|\@multi_cmdfile_update_interval\@|@multi_cmdfile_update_interval@|g;
		s|\@multi_config_dir\@|$multi_config_dir|g;
		s|\$\{multi_contrib_dir\}|@multi_contrib_dir@|g;
		s|\@multi_exec_open3\@|@multi_exec_open3@|g;
		s|\@multi_extinfo_in_status\@|@multi_extinfo_in_status@|g;
		s|\@multi_file_extension\@|@multi_file_extension@|g;
		s|\@multi_ignore_missing_cmd_file\@|@multi_ignore_missing_cmd_file@|g;
		s|\@multi_illegal_chars\@|@multi_illegal_chars@|g;
		s|\@multi_indent_label\@|@multi_indent_label@|g;
		s|\@multi_indent\@|@multi_indent@|g;
		s|\@multi_name\@|@multi_name@|g;
		s|\@multi_nagios_images\@|$multi_nagios_images|g;
		s|\@multi_no_checks_rc\@|@multi_no_checks_rc@|g;
		s|\@multi_notes_url\@|@multi_notes_url@|g;
		s|\@multi_persistent\@|@multi_persistent@|g;
		s|\@multi_pnp_path\@|$multi_pnp_path|g;
		s|\@multi_report\@|@multi_report@|g;
		s|\@multi_service_definition_template\@|$multi_service_definition_template|g;
		s|\@multi_style_plus_minus\@|@multi_style_plus_minus@|g;
		s|\@multi_tag_notes_link\@|@multi_tag_notes_link@|g;
		s|\@multi_target\@|@multi_target@|g;
		s|\@multi_tmp_dir\@|@multi_tmp_dir@|g;
		s|\@multi_tmp_etc\@|$multi_tmp_etc|g;
		s|\@multi_tmp_dir_permissions\@|@multi_tmp_dir_permissions@|g;
		s|\@multi_parent_timeout\@|@multi_parent_timeout@|g;
		s|\@multi_verbose\@|@multi_verbose@|g;
		s|\@LIBEXECDIR\@|$LIBEXECDIR|g; # put all --with-vars before directories
		s|\$\{exec_prefix\}|$exec_prefix|g; # must be next to last
		s|\$\{prefix\}|@prefix@|g; # must be last
		print OUT $_;
	}

	close IN;
	close OUT;

	if ((! -e $f) || (`diff $f $TEMP`)) {
		`mv $TEMP $f`;
	} else {
	         unlink $TEMP;
	}

}
