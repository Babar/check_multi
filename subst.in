#!@PERL@ -w

my ${prefix}="@prefix@";
my ${exec_prefix}="@exec_prefix@";
my ${libexecdir}="@prefix@/libexec";
my ${sbindir}="@sbindir@";
my ${datarootdir}="@datarootdir@";
my ${localstatedir}="@localstatedir@";
my ${checkresults_dir}="@checkresults_dir@";
my ${config_dir}="@config_dir@";
my $libdir="@libdir@";
my $sysconfdir="@sysconfdir@";
my $bindir="@bindir@";
my $srcdir="@srcdir@";

my ${image_path}="@image_path@";
my ${pnp_path}="@pnp_path@";
my ${service_definition_template}="@service_definition_template@";
my ${tmp_etc}="@tmp_etc@";

while (my $f = shift @ARGV) {

	if (-x "/bin/mktemp") { 
		$TEMP = `/bin/mktemp $f.$$.XXXXXX`;
		die "Cannot make temporary file $TEMP" if($?);
		chomp $TEMP;
	} else {
		$XXXXXX = rand;
		$TEMP = "$f.$$.$XXXXXX";
	}

	open(IN,"<$f.in") || die "Cannot open input file $f.in:$!";
	open(OUT,">${TEMP}") || die "Cannot write to temporary file ${TEMP}:$!";

	while (<IN>) {
		s|\@CHMOD\@|@CHMOD@|g;
		s|\@INSTALL\@|@INSTALL@|g;
		s|\@INSTALL_OPTS\@|@INSTALL_OPTS@|g;
		s|\@PERL\@|@PERL@|g;
		s|\@action_mouseover\@|@action_mouseover@|g;
		s|\@action_url\@|@action_url@|g;
		s|\@client_perl\@|@client_perl@|g;
		s|\@nagios_user\@|@nagios_user@|g;
		s|\@nagios_group\@|@nagios_group@|g;
		s|\@child_timeout\@|@child_timeout@|g;
		s|\@collapse\@|@collapse@|g;
		s|\@cmdfile_update_interval\@|@cmdfile_update_interval@|g;
		s|\@config_dir\@|$config_dir|g;
		s|\$\{contrib_dir\}|@contrib_dir@|g;
		s|\@ethtool\@|@ethtool@|g;
		s|\@exec_open3\@|@exec_open3@|g;
		s|\@extinfo_in_status\@|@extinfo_in_status@|g;
		s|\@file_extension\@|@file_extension@|g;
		s|\@findbin\@|@findbin@|g;
		s|\@ignore_missing_cmd_file\@|@ignore_missing_cmd_file@|g;
		s|\@illegal_chars\@|@illegal_chars@|g;
		s|\@indent_label\@|@indent_label@|g;
		s|\@indent\@|@indent@|g;
		s|\@localstatedir\@|@localstatedir@|g;
		s|\@name\@|@name@|g;
		s|\@no_checks_rc\@|@no_checks_rc@|g;
		s|\@notes_url\@|@notes_url@|g;
		s|\@persistent\@|@persistent@|g;
		s|\@pnp_path\@|$pnp_path|g;
		s|\@report\@|@report@|g;
		s|\@service_definition_template\@|$service_definition_template|g;
		s|\@style_plus_minus\@|@style_plus_minus@|g;
		s|\@tag_notes_link\@|@tag_notes_link@|g;
		s|\@target\@|@target@|g;
		s|\@tmp_dir\@|@tmp_dir@|g;
		s|\@tmp_etc\@|$tmp_etc|g;
		s|\@tmp_dir_permissions\@|@tmp_dir_permissions@|g;
		s|\@parent_timeout\@|@parent_timeout@|g;
		s|\@verbose\@|@verbose@|g;
		s|\@sbindir\@|$sbindir|g;		# put all --with-vars before directories
		s|\@checkresults_dir\@|$checkresults_dir|g;
		s|\@sysconfdir\@|$sysconfdir|g;
		s|\@datarootdir\@|$datarootdir|g;
		s|\@image_path\@|$image_path|g;		
		s|\@localstatedir\@|$localstatedir|g;
		s|\@libexecdir\@|$libexecdir|g;	
		s|\$\{exec_prefix\}|$exec_prefix|g;	# must be next to last
		s|\$\{prefix\}|@prefix@|g;		# must be last
		print OUT $_;
	}

	close IN;
	close OUT;

	if ((! -e $f) || (`diff $f $TEMP`)) {
		`mv $TEMP $f`;
	} else {
	         unlink $TEMP;
	}

}
