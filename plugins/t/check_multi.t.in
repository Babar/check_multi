#! @PERL@ -w -I ..
#
# Process Tests via check_multi
# thanks to Ton Voon for his persistency on testing ;)
#

use strict;
use Test::More;
use NPTest;

my $t;

#--- add $libexec_dir to PATH to be sure that plugins will be called from libexec_dir
my $libexec_dir="@libexecdir@";
my $plugin_path="@plugin_path@";
$ENV{PATH}="$libexec_dir:$plugin_path:$ENV{PATH}";

#--- check needed plugins for tests
my @plugins=(
	"check_procs",
	"echo",
	"@PERL@",
);
foreach my $plugin (@plugins) {
	my $path_to_plugin=`which $plugin`; chomp $path_to_plugin;
	if (! -x "$path_to_plugin") {
		plan skip_all => "tests because component $plugin not found or not executable as \'$path_to_plugin\'";
	}
}
my $path_to_check_procs=`which check_procs`; chomp $path_to_check_procs;
my $procs_string="";
my $procs_warning="";
my $procs_output=`$path_to_check_procs -w 10`; chomp $procs_output;
if ($procs_output=~/PROCS (\S+): \d+ (\S+)/) {
	$procs_warning=$1;
	$procs_string=$2;
} else {
	plan skip_all => "tests because check_procs output ($procs_output) does not match pattern (PROCS (\\S+): \\d+ (\\s+))";
}
plan tests => 70;

my $result;
my $testopts="-s dont_be_paranoid=1 -s tmp_dir=/tmp/check_multi";

#-------------------------------------------------------------------------------
#--- check_multi version -------------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -V"
);
print '-'x 80 ; print "\n";
print $result->output; print "\n";
print '-'x 80 ; print "\n";
is(
	$result->return_code, 
	3, 
	"check_multi version - RC3"
);
like(
	$result->output,
	'/^Version: check_multi_v\d{3}_\d{4}-\d{2}-\d{2}-\d{2}:\d{2}\n'.
	'configure.*$/',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- ENV vars MULTI_... via command --------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ echo ] = echo \"Hello World\"' -x 'command [ env ] = env | grep MULTI | sort' -r 1 $testopts",
);
is(
	$result->return_code, 
	0, 
	"environment variables assignment via command - RC0"
);
like(
	$result->output,
	'/^OK - 2 plugins checked, 2 ok\n'.
	'\[ 1\] echo Hello World\n'.
	'\[ 2\] env MULTI_1=Hello World\n'.
	' MULTI_1_LABEL=OK\n'.
	' MULTI_1_NAME=echo\n'.
	' MULTI_1_RC=0\n'.
	' MULTI_1_RC_LABEL=OK\n'.
	' MULTI_1_STATE=0\n'.
	' MULTI_2_NAME=env\n'.
	'.*$/s',
	"output correct"
);
#-------------------------------------------------------------------------------
#--- ENV vars MULTI_... via eval -----------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'eeval [ echo ] = \"Hello World\";' -x 'command [ env ] = env | grep MULTI | sort' -r 1 $testopts",
);
is(
	$result->return_code, 
	0, 
	"environment variables assignment via eeval - RC0"
);
like(
	$result->output,
	'/^OK - 2 plugins checked, 2 ok\n'.
	'\[ 1\] echo Hello World\n'.
	'\[ 2\] env MULTI_1=Hello World\n'.
	' MULTI_1_LABEL=OK\n'.
	' MULTI_1_NAME=echo\n'.
	' MULTI_1_RC=0\n'.
	' MULTI_1_RC_LABEL=OK\n'.
	' MULTI_1_STATE=0\n'.
	' MULTI_2_NAME=env\n'.
	'.*$/s',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- valid name option -------------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -n test -x 'command [ procs ] = check_procs' $testopts"
);
is(
	$result->return_code, 
	0, 
	"valid name option - RC0"
);
like(
	$result->output,
	'/^test OK - 1 plugins checked, 1 ok\n'.
	'\[ 1\] procs PROCS OK: \d+ '.$procs_string.'|check_multi::check_multi::plugins=1 time=\d+$/',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- invalid name option -----------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -n test: -x 'command [ procs ] = check_procs' $testopts"
);
is(
	$result->return_code, 
	3, 
	"invalid name option - RC3"
);
like(
	$result->output,
	'/^check_multi error: name \'test:\' invalid - using non allowed characters/',
	"output correct"
);


#-------------------------------------------------------------------------------
#--- simple OK output with 1 plugin --------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ procs ] = check_procs' $testopts"
);
is(
	$result->return_code, 
	0, 
	"default report option - RC0"
);
like(
	$result->output,
	'/^OK - 1 plugins checked, 1 ok\n'.
	'\[ 1\] procs PROCS OK: \d+ '.$procs_string.'|check_multi::check_multi::plugins=1 time=\d+$/',
	"output correct"
);


#-------------------------------------------------------------------------------
#--- report option 0 -----------------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -r 0 -x 'command [ procs ] = check_procs' $testopts"
);
is(
	$result->return_code, 
	0, 
	"report option 0 (all states shown) - RC0"
);
like(
	$result->output,
	'/^OK - 1 plugins checked, 0 critical, 0 warning, 0 unknown, 1 ok\n'.
	'\[ 1\] procs PROCS OK: \d+ '.$procs_string.'$/',
	"output correct"
);


#-------------------------------------------------------------------------------
#--- report option 1 -----------------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -r 1 -x 'command [ procs ] = check_procs -w 1' $testopts"
);
is(
	$result->return_code, 
	1, 
	"report option 1 (non-OK service names in state list) - RC1"
);
like(
	$result->output,
	'/^WARNING - 1 plugins checked, 1 warning \(procs\)\n'.
	'\[ 1\] procs PROCS '.$procs_warning.': \d+ '.$procs_string.'$/',
	"output correct"
);


#-------------------------------------------------------------------------------
#--- report option 2 -----------------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -r 2 -x 'command [ procs ] = check_procs' $testopts"
);
is(
	$result->return_code, 
	0, 
	"report option 2 (HTML) - RC0"
);
like(
	$result->output,
	'/^OK - 1 plugins checked, 0 critical, 0 warning, 0 unknown, 1 ok\n'.
	'<SCRIPT LANGUAGE=\'JavaScript\'> function Toggle.*PROCS OK: \d+ '.$procs_string.'.*div>$/',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- report option 4 -----------------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -r 4 -x 'command [ procs ] = check_prox' $testopts"
);
is(
	$result->return_code, 
	3, 
	"report option 4 [error messages - stderr] - RC3"
);
like(
	$result->output,
	'/^UNKNOWN - 1 plugins checked, 0 critical, 0 warning, 1 unknown, 0 ok\n'.
	'\[ 1\] procs  \[sh: check_prox: (command )?not found,RC was 127!\]$/',
	"output correct"
);


#-------------------------------------------------------------------------------
#--- report option 8 -----------------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ eins ] = echo \"1|eins=1\"' -x 'command [ zwei ] = echo \"2|zwei=2\"' -r 8 $testopts"
);
is(
	$result->return_code, 
	0, 
	"report option 8 (check_multi perfdata) - RC0"
);
like(
	$result->output,
	'/^OK - 2 plugins checked, 0 critical, 0 warning, 0 unknown, 2 ok\n'.
	'\[ 1\] eins 1\n'.
	'\[ 2\] zwei 2\|check_multi::check_multi::plugins=2 time=\d+\.\d+ eins::echo::eins=1 zwei::echo::zwei=2 $/',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- perfdata tag ::plugin in command ------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ eins::myplugin ] = echo \"1|eins=1\"' -r 8 $testopts"
);
is(
	$result->return_code, 
	0, 
	"perfdata plugin specified by command [ tag::plugin ] - RC0"
);
like(
	$result->output,
	'/^OK - 1 plugins checked, 0 critical, 0 warning, 0 unknown, 1 ok\n'.
	'\[ 1\] eins 1|check_multi::check_multi::plugins=1 time=\d+\.\d+ eins::myplugin::eins=1 $/',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- perfdata tag ::plugin in eeval ---------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'eeval [ eins::myplugin ] = \"1|eins=1\"' -r 8 $testopts"
);
is(
	$result->return_code, 
	0, 
	"perfdata plugin specified by eeval [ tag::plugin ] - RC0"
);
like(
	$result->output,
	'/^OK - 1 plugins checked, 0 critical, 0 warning, 0 unknown, 1 ok\n'.
	'\[ 1\] eins 1|check_multi::check_multi::plugins=1 time=\d+\.\d+ eins::myplugin::eins=1 $/',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- report option 8 with extended_perddata ------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ eins ] = echo \"1|eins=1\"' -x 'command [ zwei ] = echo \"2|zwei=2\"' -r 8 -s extended_perfdata=1 $testopts"
);
is(
	$result->return_code, 
	0, 
	"report option 8 (check_multi perfdata) - RC0"
);
like(
	$result->output,
	'/^OK - 2 plugins checked, 0 critical, 0 warning, 0 unknown, 2 ok\n'.
	'\[ 1\] eins 1\n'.
	'\[ 2\] zwei 2\|check_multi::check_multi::plugins=2 time=\d+\.\d+ check_multi_extended::check_multi_extended::count_ok=2 count_warning=0 count_critical=0 count_unknown=0 overall_state=0 eins::echo::eins=1 zwei::echo::zwei=2 $/',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- report option 32 ----------------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ eins ] = echo \"1|eins=1\"' -x 'command [ zwei ] = echo \"2|zwei=2\"' -r 32 $testopts"
);
is(
	$result->return_code, 
	0, 
	"report option 32 (classical perfdata) - RC0"
);
like(
	$result->output,
	'/^OK - 2 plugins checked, 0 critical, 0 warning, 0 unknown, 2 ok\n'.
	'\[ 1\] eins 1\n'.
	'\[ 2\] zwei 2\|eins=1 zwei=2 $/',
	"output correct"
);


#-------------------------------------------------------------------------------
#--- report option 64 ----------------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ eins ] = echo \"1|eins=1\"' -x 'command [ zwei ] = echo \"2|zwei=2\"' -r 64 $testopts"
);
is(
	$result->return_code, 
	0, 
	"report option 64 (state in front of output) - RC0"
);
like(
	$result->output,
	'/^OK - 2 plugins checked, 0 critical, 0 warning, 0 unknown, 2 ok\n'.
	'\[ 1\] eins OK 1\n'.
	'\[ 2\] zwei OK 2$/',
	"output correct"
);


#-------------------------------------------------------------------------------
#--- report option 143 ---------------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ eins ] = echo \"1|eins=1\"' -x 'command [ zwei ] = echo \"2|zwei=2\"' -r 143 $testopts"
);
is(
	$result->return_code, 
	0, 
	"report option 143 (HTML performance output with PNP link) - RC0"
);
like(
	$result->output,
	'/^check_multi OK - 2 plugins checked, 2 ok\n'.
	'.*<img src=.*Show performance chart.*'.
	'.*zwei::echo::zwei=2 $/',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- report option 256 ---------------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ proc ] = check_procs' -r 256 $testopts"
);
is(
	$result->return_code, 
	0, 
	"report option 256 (XML output) - RC0"
);

#?xml version="1.0"?>
#<?xml-stylesheet type="text/xsl" href="extinfo.xsl"?>
#<div id="check_multi_xml" style='display:none'>
#<check_multi>
#        <CHILD>
#                <no>0</no>
#                <endtime>1275582892.30824</endtime>
#                <nallchecks>1</nallchecks>
#                <name></name>
#                <nchecks>1</nchecks>
#                <number>0</number>
#                <rc>0</rc>
#                <runtime>0.0230729579925537</runtime>
#                <sleeped>0</sleeped>
#                <starttime>1275582892.28517</starttime>
#                <timeouttime>1275582952.28517</timeouttime>
#                <output>0 critical, 0 warning, 0 unknown, 1 ok</output>
#                <error>report_xml: XML element critical not found</error>
#                <error>report_xml: XML element ok not found</error>
#                <error>report_xml: XML element unknown not found</error>
#                <error>report_xml: XML element warning not found</error>
#        </CHILD>
#        <CHILD>
#                <no>1</no>
#                <command>check_procs</command>
#                <displayed>1</displayed>
#                <endtime>1275582892.30783</endtime>
#                <error></error>
#                <name>procs</name>
#                <number>1</number>
#                <output>PROCS OK: 152 processes</output>
#                <plugin>check_procs</plugin>
#                <pplugin>check_procs</pplugin>
#                <process_perfdata>1</process_perfdata>
#                <rc>0</rc>
#                <runtime>0.0226080417633057</runtime>
#                <starttime>1275582892.28522</starttime>
#                <type>command</type>
#        </CHILD>
#</check_multi>
#</div>
like(
	$result->output,
	'/^<\?xml version'.
	'.*<no>0<\/no>'.
	'.*<rc>0<\/rc>'.
	'.*<no>1<\/no>'.
	'.*<command>check_procs<\/command>'.
	'.*<output>PROCS.*<\/output>'.
	'.*<type>command<\/type>.*$/s',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- check_multi encode  (report option 16384) ---------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -r 16384 -x 'command [ encode ] = echo encode' $testopts",
);
is(
	$result->return_code, 
	0, 
	"report option 16384 - encode commands - RC0"
);
like(
	$result->output,
	'/command%20%5B%20encode%20%5D%20%3D%20echo%20encode%0A/',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- check_multi hide OK states (report option 32768) --------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -r 32768 -x 'command [ OK ] = (echo 0; exit 0)' -x 'command [ WARNING ] = (echo 1; exit 1)' $testopts",
);
is(
	$result->return_code, 
	1, 
	"report option 32768 - hide OK states - RC1"
);
like(
	$result->output,
	'/WARNING - 2 plugins checked, 0 critical, 1 warning, 0 unknown, 1 ok\n'.
	'\[ 2\] WARNING 1/',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- check_multi hide OK states (report option 32770) --------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -r 32768+2 -x 'command [ OK ] = (echo 0; exit 0)' $testopts",
);
is(
	$result->return_code, 
	0, 
	"report option 32768+2 - hide OK states in HTML mode - RC1"
);
like(
	$result->output,
	'/OK - 1 plugins checked, 0 critical, 0 warning, 0 unknown, 1 ok\n'.
	'.*OK/',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- check_multi decode (of encoded command) -----------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -f command%20%5B%20encode%20%5D%20%3D%20echo%20encode%0A $testopts",
);
is(
	$result->return_code, 
	0, 
	"decode encoded command - RC0"
);
like(
	$result->output,
	'/OK - 1 plugins checked, 1 ok\n'. 
	'\[ 1\] encode encode\|check_multi::check_multi::plugins=1 time=\d+\.\d+/',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- check_multi recursive -----------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x \'command [ child1 ] = @PERL@ ../check_multi -x \"command [ grandchild1 ] = echo g1\" $testopts\' -r 1 $testopts"
);
is(
	$result->return_code, 
	0, 
	"recursive (check_multi calls check_multi) - RC0"
);
like(
	$result->output,
	'/^OK - 1 plugins checked, 1 ok\n'.
	'\[ 1\] child1 OK - 1 plugins checked, 1 ok\n'.
	' \[ 1\] grandchild1 g1$/',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- discarding perfdata  ------------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ eins ] = echo \"eins|eins=1,1\"' -r 1+4+8  $testopts -s loose_perfdata=0",
);
is(
	$result->return_code, 
	0, 
	"discards invalid perfdata - RC0"
);
like(
	$result->output,
	'/^OK - 1 plugins checked, 1 ok\n'.
	'\[ 1\] eins eins \[eins perfdata discarded for eins: bad UOM \',\' in data \'1,1\' \]\|check_multi::check_multi::plugins=1 time=\d+\.\d+ $/',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- accepting loose German perfdata -------------------------------------------
#-------------------------------------------------------------------------------
my $old_ENV_LANG=$ENV{LANG};
$ENV{LANG}="de_DE";
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ eins ] = echo \"eins|eins=1,1\"' -r 9 -s loose_perfdata=1 $testopts",
);
is(
	$result->return_code, 
	0, 
	"accepting loose perfdata - RC0"
);
like(
	$result->output,
	'/^OK - 1 plugins checked, 1 ok\n'.
	'\[ 1\] eins eins\|check_multi::check_multi::plugins=1 time=\d+\.\d+ eins::echo::eins=1\,1 $/',
	"output correct"
);
$ENV{LANG}=$old_ENV_LANG;

#-------------------------------------------------------------------------------
#--- accepting trailing semicolon (e.g. nsclient++ -----------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ eins ] = echo \"eins|eins=1;2;3;4;5;\"' -r 9 -s loose_perfdata=1 $testopts",
);
is(
	$result->return_code, 
	0, 
	"accepting loose perfdata with trailing semicolon - RC0"
);
like(
	$result->output,
	'/^OK - 1 plugins checked, 1 ok\n'.
	'\[ 1\] eins eins\|check_multi::check_multi::plugins=1 time=\d+\.\d+ eins::echo::eins=1\;2\;3\;4\;5\; $/',
	"output correct"
);

#-------------------------------------------------------------------------------
#--- overloading ---------------------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ eins ] = echo original' -x 'command [ eins ] = echo overloaded' -r 1 $testopts",
);
is(
	$result->return_code, 
	0, 
	"overloading commands - RC0"
);
like(
	$result->output,
	'/^OK - 1 plugins checked, 1 ok\n'.
	'\[ 1\] eins overloaded$/',
	"output correct"
);
#-------------------------------------------------------------------------------
#--- killing me softly - checking signal handler -------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'eeval [ killing_me_HUPly ] = kill 1, \$\$;' -r 1 $testopts",
);
is(
	$result->return_code, 
	3, 
	"testing signal handler - RC0"
);
like(
	$result->output,
	'/^OK - 1 plugins checked, 1 ok \[HUP generated at line 1 in.*\]\n'.
	'\[ 1\] killing_me_HUPly $/',
	"output correct"
);
#-------------------------------------------------------------------------------
#--- output / head -------------------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ procs ] = check_procs' -x 'output [ head ] = \"%.20s processes running\",(split(/\\s+/,\"\$procs\$\"))\[2\]' -r 1 $testopts",
);
is(
	$result->return_code, 
	0, 
	"custom output for header line - RC0"
);
like(
	$result->output,
	'/\\d+ processes running\n'.
	'\[ 1\] procs PROCS OK: \\d+ '.$procs_string.'$/',
	"output correct"
);
#-------------------------------------------------------------------------------
#--- check_multi attribute -----------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ with_perfdata ] = echo \"eins\|eins=1\"' -x 'attribute [ with_perfdata::process_perfdata ] = 0' -r 9 $testopts",
);
is(
	$result->return_code, 
	0, 
	"changes child check attributes - RC0"
);
like(
	$result->output,
	'/OK - 1 plugins checked, 1 ok\n'.
	'\[ 1\] with_perfdata eins\|check_multi::check_multi::plugins=1 time=[\d\.]+ $/',
	"output correct"
);
#-------------------------------------------------------------------------------
#--- check_multi cumulate ------------------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'cumulate [ procs ] = ps -axo \"user rss\"' $testopts",
);
is(
	$result->return_code, 
	0, 
	"cumulates data like top - RC0"
);
like(
	$result->output,
	'/OK - 5 plugins checked, 5 ok\n'.
	'\[ 1\] \S+ \d+\n'.
	'\[ 2\] \S+ \d+\n'.
	'\[ 3\] \S+ \d+\n'.
	'\[ 4\] \S+ \d+\n'.
	'\[ 5\] \S+ \d+\|'.
	'check_multi::check_multi::plugins=5 time=[\d\.]+ \S+::cumulate::\S+=\d+ \S+::cumulate::\S+=\d+ \S+::cumulate::\S+=\d+ \S+::cumulate::\S+=\d+ \S+::cumulate::\S+=\d+ $/',
	"output correct"
);
#-------------------------------------------------------------------------------
#--- check_multi child and global timeout --------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ one ] = ( sleep 2; echo one)' -x 'command [ two ] = echo two' -r 5 -t 1 -T 2 $testopts",
);
is(
	$result->return_code, 
	3, 
	"timeout check: child one killed, child two cancelled - RC3"
);
like(
	$result->output,
	'/UNKNOWN - 2 plugins checked, 2 unknown \(one, two\)\n'.
	'\[ 1\] one  \[timeout after 1s\]\n'.
	'\[ 2\] two UNKNOWN - execution cancelled due to global timeout \(2s\)/',
	"output correct"
);
#-------------------------------------------------------------------------------
#--- check_multi object cache macros - objects.cache does not exist ------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ hostgroup_members ] = echo \$hostgroup:members:hostgroup_name:linux-servers\$' -r 5 $testopts -s objects_cache=not.there",
);
is(
	$result->return_code, 
	3, 
	"object cache macro check - non existing objects.cache file - RC3"
);
like(
	$result->output,
	'/UNKNOWN - 1 plugins checked, 1 unknown \(hostgroup_members\) \[parse_objects_cache: error opening file not.there:No such file or directory\]\n'.
	'\[ 1\] hostgroup_members/',
	"output correct"
);
#-------------------------------------------------------------------------------
#--- check_multi object cache macros with invalid object -----------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ invalid ] = echo \$invalid:members:hostgroup_name:linux-servers\$' -r 5 $testopts -s objects_cache=objects.cache",
);
is(
	$result->return_code, 
	3, 
	"object cache macro check - invalid object name - RC3"
);
like(
	$result->output,
	'/UNKNOWN - 1 plugins checked, 1 unknown \(invalid\) \[parse_objects_cache: unknown object type \"invalid\" - valid types are command,contact,contactgroup,host,hostgroup,service,timeperiod\]\n'.
	'\[ 1\] invalid/', 
	"output correct"
);
#-------------------------------------------------------------------------------
#--- check_multi object cache macros -------------------------------------------
#-------------------------------------------------------------------------------
$result = NPTest->testCmd(
	"@PERL@ ../check_multi -x 'command [ hostgroup_members ] = echo \$hostgroup:members:hostgroup_name:linux-servers\$' -x 'command [ services ] = echo \$service:service_description:host_name:localhost\$' -r 5 $testopts -s objects_cache=objects.cache",
);
is(
	$result->return_code, 
	0, 
	"object cache macro check - hostgroup and services - RC0"
);
like(
	$result->output,
	'/OK - 2 plugins checked, 2 ok\n'.
	'\[ 1\] hostgroup_members localhost\n'.
	'\[ 2\] services Current Load,Current Users,HTTP,PING,Root Partition,SSH,Swap Usage,Total Processes/',
	"output correct"
);
